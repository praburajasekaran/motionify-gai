---
phase: 04-integration-and-polish
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - components/proposals/CommentThread.tsx
  - components/proposals/CommentInput.tsx
  - landing-page-new/src/components/CommentThread.tsx
  - landing-page-new/src/components/CommentInput.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User uploads file and posts comment - attachment appears in comment thread"
    - "User clicks Edit button on their comment - inline editor opens"
    - "New comments arrive via polling - scroll position preserved if user was reading"
  artifacts:
    - path: "components/proposals/CommentInput.tsx"
      provides: "Attachment data flow to parent"
      exports: ["CommentInput"]
    - path: "components/proposals/CommentThread.tsx"
      provides: "Attachment ref wiring from child"
      contains: "onAttachmentsChange"
    - path: "landing-page-new/src/components/CommentInput.tsx"
      provides: "Attachment data flow to parent"
      exports: ["CommentInput"]
    - path: "landing-page-new/src/components/CommentThread.tsx"
      provides: "Attachment ref wiring from child"
      contains: "onAttachmentsChange"
  key_links:
    - from: "CommentInput"
      to: "CommentThread"
      via: "onAttachmentsChange callback"
      pattern: "onAttachmentsChange.*pendingAttachments"
    - from: "CommentInput"
      to: "CommentThread"
      via: "pendingAttachmentsRef population"
      pattern: "pendingAttachmentsRef\\.current\\s*="
---

<objective>
Fix component wiring gaps identified in v1 milestone audit to restore attachment metadata flow and ensure edit handler is accessible.

**Purpose:** Address critical integration gaps preventing attachments from linking to comments and edit functionality from being accessible in the UI.

**Output:** Working attachment flow (files link to comments on submit), accessible edit handlers, and preserved scroll position during polling updates.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1-MILESTONE-AUDIT.md
@.planning/phases/03-attachments-and-notifications/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Wire attachment data flow from CommentInput to CommentThread</name>
  <files>
    components/proposals/CommentInput.tsx
    components/proposals/CommentThread.tsx
    landing-page-new/src/components/CommentInput.tsx
    landing-page-new/src/components/CommentThread.tsx
  </files>
  <action>
**Problem:** CommentInput collects `pendingAttachments` in local state but never communicates them to CommentThread. When `onSubmit(content.trim())` is called (line 157 in both CommentInput files), the attachment metadata is lost. CommentThread has `pendingAttachmentsRef` but it's never populated.

**Solution:** Add callback prop to pass attachment data from child to parent.

**For BOTH admin portal (`components/proposals/`) and client portal (`landing-page-new/src/components/`):**

1. **Update CommentInput.tsx:**
   - Add `onAttachmentsChange?: (attachments: PendingAttachment[]) => void` to props interface
   - After `setPendingAttachments` call (line 119-128), immediately call `onAttachmentsChange?.(...)` with the new attachments array
   - Export `PendingAttachment` type from CommentInput (currently defined but not exported)

2. **Update CommentThread.tsx:**
   - Add `onAttachmentsChange` prop to `<CommentInput />` render (line 224 admin, line 290 client)
   - Implement handler: `const handleAttachmentsChange = (attachments: PendingAttachment[]) => { pendingAttachmentsRef.current = attachments; }`
   - Pass handler: `onAttachmentsChange={handleAttachmentsChange}`

**Why this approach:** Preserves existing `pendingAttachmentsRef` pattern in CommentThread while establishing parent-child communication. Avoids lifting state unnecessarily.

**Do NOT:**
- Change the existing `handleSubmit` logic in CommentThread (lines 120-141 admin, 177-195 client) - it already correctly uses `pendingAttachmentsRef`
- Modify the attachment creation loop (already correct)
- Change scroll preservation logic (already implemented correctly)
  </action>
  <verify>
    npm run build (admin portal)
    cd landing-page-new && npm run build (client portal)
  </verify>
  <done>
Both portals build without TypeScript errors. CommentInput exports PendingAttachment type. CommentThread passes onAttachmentsChange to CommentInput. pendingAttachmentsRef is populated when files are uploaded.
  </done>
</task>

<task type="auto">
  <name>Verify scroll preservation implementation</name>
  <files>
    components/proposals/CommentThread.tsx
    landing-page-new/src/components/CommentThread.tsx
  </files>
  <action>
**Confirm existing implementation is correct:**

Both CommentThread files already implement scroll preservation (admin lines 25, 82-113; client lines 74, 137-170). Verify the implementation follows best practices:

1. Check `scrollPosRef` initialization (should be `{ container: 0, active: false }`)
2. Check `handleScroll` sets `active: true` when user scrolls
3. Check `pollForNewComments` reads `wasActive` before state update
4. Check scroll restoration uses `requestAnimationFrame`
5. Check `scrollContainerRef` is attached to scrollable div
6. Check `onScroll={handleScroll}` is wired to the scrollable div

**Expected result:** All checks pass. Scroll preservation is already correctly implemented.

**If ANY issues found:** Fix them to match the working pattern from the other portal.
  </action>
  <verify>
    grep -n "scrollPosRef" components/proposals/CommentThread.tsx landing-page-new/src/components/CommentThread.tsx
    grep -n "handleScroll" components/proposals/CommentThread.tsx landing-page-new/src/components/CommentThread.tsx
  </verify>
  <done>
Scroll preservation logic confirmed correct in both portals. scrollPosRef initialized, handleScroll wired, pollForNewComments preserves position.
  </done>
</task>

<task type="auto">
  <name>Verify edit handler wiring</name>
  <files>
    components/proposals/CommentThread.tsx
    components/proposals/CommentItem.tsx
    landing-page-new/src/components/CommentThread.tsx
    landing-page-new/src/components/CommentItem.tsx
  </files>
  <action>
**Confirm existing implementation is correct:**

Both CommentThread files already pass `onEdit={handleEdit}` to CommentItem (admin line 216, client line 282). Verify the complete edit flow:

1. Check `handleEdit` function exists in CommentThread (admin line 143-148, client line 197-209)
2. Check `handleEdit` is passed to `<CommentItem onEdit={handleEdit} />`
3. Check CommentItem accepts `onEdit` prop in interface (line 43 both files)
4. Check CommentItem calls `onEdit?.(comment.id, trimmedContent)` on save (line 105 both files)
5. Check edit button is visible to comment owners (line 135-143 both files)

**Expected result:** All checks pass. Edit handler is already correctly wired.

**If ANY issues found:** Fix them to match the working pattern from the other portal.
  </action>
  <verify>
    grep -n "onEdit" components/proposals/CommentThread.tsx components/proposals/CommentItem.tsx
    grep -n "onEdit" landing-page-new/src/components/CommentThread.tsx landing-page-new/src/components/CommentItem.tsx
  </verify>
  <done>
Edit handler confirmed wired in both portals. CommentThread passes handleEdit to CommentItem. Edit button visible and functional.
  </done>
</task>

</tasks>

<verification>
**Build Verification:**
```bash
npm run build
cd landing-page-new && npm run build
```

**Type Safety:**
- CommentInput exports PendingAttachment type
- onAttachmentsChange prop correctly typed
- No TypeScript errors in either portal

**Data Flow:**
- CommentInput calls onAttachmentsChange when pendingAttachments change
- CommentThread's handleAttachmentsChange updates pendingAttachmentsRef
- handleSubmit in CommentThread uses pendingAttachmentsRef to create attachments

**Existing Implementations:**
- Scroll preservation logic verified correct
- Edit handler wiring verified correct
</verification>

<success_criteria>
1. **Attachment metadata flows to parent**
   When user uploads file in CommentInput, pendingAttachmentsRef in CommentThread is populated with attachment metadata.

2. **Attachments link to comments on submit**
   When user posts comment with attachment, createAttachment is called for each pending attachment with the new comment's ID.

3. **Both portals implement attachment flow**
   Admin portal and client portal both correctly wire attachment data from CommentInput to CommentThread.

4. **Scroll preservation confirmed working**
   Polling updates preserve scroll position when user was actively reading (scrolled down past 100px).

5. **Edit handler confirmed wired**
   Edit button on user's own comments opens inline editor and calls handleEdit on save.

6. **Clean builds**
   Both admin and client portal build without errors or type warnings.
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-and-polish/04-01-SUMMARY.md`
</output>
