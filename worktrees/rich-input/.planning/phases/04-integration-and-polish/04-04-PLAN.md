---
phase: 04-integration-and-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - components/proposals/CommentThread.tsx
  - landing-page-new/src/components/CommentThread.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Page scrolls to show new comment when posted by another user"
    - "Scroll position preserved when user reading middle of thread"
    - "Auto-scroll only happens when user near bottom or after own comment"
  artifacts:
    - path: "components/proposals/CommentThread.tsx"
      provides: "Smart auto-scroll logic"
      pattern: "scrollBehavior|isNearBottom"
    - path: "landing-page-new/src/components/CommentThread.tsx"
      provides: "Client portal auto-scroll"
      pattern: "scrollBehavior|isNearBottom"
  key_links:
    - from: "pollForNewComments"
      to: "scrollToBottom"
      via: "detect scroll position, conditionally scroll"
      pattern: "scrollHeight.*scrollTop.*clientHeight"
---

<objective>
Implement smart auto-scroll that shows new comments when user near bottom while preserving scroll when reading middle.

Purpose: Resolve Gap 6 - new comments don't trigger scroll, user must manually scroll down to see them.
Output: Scroll intelligently adapts to user position.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-and-polish/04-UAT.md
@.planning/phases/04-integration-and-polish/04-01-SUMMARY.md

## Root Cause (from UAT diagnosis)

**Gap 6: Page doesn't scroll to new comment (major)**
- User reported: "the page doesn't scroll to the new comment."
- Root cause: CommentThread lacks auto-scroll logic. Scroll-preservation mechanism actively prevents scrolling by restoring previous scroll position
- Location: Both CommentThread components
- Fix: Implement smart auto-scroll - detect if user near bottom, auto-scroll if near bottom, preserve if reading middle, always scroll after own comment

**Note:** Gap 5 (polling stale closure) is already resolved by user - polling now works.

## Debug Session

See detailed analysis: `.planning/debug/scroll-to-new-comment.md`

## Recommended Approach

Calculate scroll position threshold (e.g., within 100px of bottom = "near bottom"), conditionally scroll based on position.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement smart auto-scroll for new comments</name>
  <files>
components/proposals/CommentThread.tsx
landing-page-new/src/components/CommentThread.tsx
  </files>
  <action>
In both CommentThread components, add smart auto-scroll logic that:
- Scrolls to bottom when user near bottom (within 100px)
- Preserves scroll position when user reading middle
- Always scrolls after user posts own comment

**Add scroll detection helper (~line 40-50):**
```typescript
// Check if user is near bottom of comment thread
const isNearBottom = () => {
  if (!scrollContainerRef.current) return false;
  const { scrollHeight, scrollTop, clientHeight } = scrollContainerRef.current;
  const distanceFromBottom = scrollHeight - scrollTop - clientHeight;
  return distanceFromBottom < 100; // Within 100px of bottom
};

// Scroll to bottom smoothly
const scrollToBottom = () => {
  if (!scrollContainerRef.current) return;
  scrollContainerRef.current.scrollTo({
    top: scrollContainerRef.current.scrollHeight,
    behavior: 'smooth'
  });
};
```

**Update pollForNewComments to conditionally scroll:**
Find the pollForNewComments function and add auto-scroll logic when new comments are detected:

```typescript
const pollForNewComments = useCallback(async () => {
  const newComments = await getComments(proposalId, lastPolledAtRef.current);

  if (newComments && newComments.length > 0) {
    const wasNearBottom = isNearBottom();

    setComments(prev => [...prev, ...newComments]);
    lastPolledAtRef.current = new Date();

    // Auto-scroll if user was near bottom
    if (wasNearBottom) {
      // Use setTimeout to ensure DOM updated before scrolling
      setTimeout(() => scrollToBottom(), 50);
    }
    // Otherwise preserve scroll position (existing scrollPosRef logic)
  }
}, [proposalId]);
```

**Update handleSubmit to always scroll after own comment:**
```typescript
const handleSubmit = async (content: string, attachmentIds?: string[]) => {
  try {
    await createComment({
      proposalId,
      content,
      userId,
      userName,
      attachmentIds,
    });

    // Always scroll to show own comment
    setTimeout(() => scrollToBottom(), 100);

    // Reset polling timestamp to fetch own comment
    lastPolledAtRef.current = new Date();
  } catch (error) {
    // ...
  }
};
```

**Ensure scrollContainerRef attached to scrollable element:**
Verify that the comment list container has the ref:
```typescript
<div ref={scrollContainerRef} onScroll={handleScroll} className="...">
  {comments.map(comment => <CommentItem key={comment.id} {...comment} />)}
</div>
```

Apply to both:
1. `components/proposals/CommentThread.tsx` (admin portal)
2. `landing-page-new/src/components/CommentThread.tsx` (client portal)
  </action>
  <verify>
Manual test (two browsers):

**Test 1: Auto-scroll when near bottom**
1. Open proposal with 10+ comments
2. Scroll to bottom
3. Post new comment from other browser
4. Wait 10 seconds
5. Verify: Page scrolls smoothly to show new comment

**Test 2: Preserve scroll when reading middle**
1. Open proposal with 10+ comments
2. Scroll to middle of thread
3. Post new comment from other browser
4. Wait 10 seconds
5. Verify: Scroll position unchanged (no jump to bottom)

**Test 3: Always scroll after own comment**
1. Post a comment
2. Verify: Page scrolls to show newly posted comment immediately
3. No need to scroll manually to see own comment
  </verify>
  <done>
Smart auto-scroll implemented. Comments appear at bottom when user near bottom. Scroll preserved when reading middle. Own comments always visible after posting.
  </done>
</task>

</tasks>

<verification>

**Auto-scroll behavior:**
1. User near bottom (within 100px): New comment → auto-scroll
2. User in middle: New comment → preserve position
3. User posts comment: Auto-scroll to show own comment
4. Smooth scrolling (behavior: 'smooth')

**Test both portals:**
- Admin portal (Vite SPA)
- Client portal (Next.js)
</verification>

<success_criteria>

1. Page scrolls to new comment when user near bottom
2. Scroll position preserved when user reading middle
3. Own comments always visible after posting (auto-scroll)
4. Smooth scroll animation (not instant jump)
5. Both admin and client portals have working auto-scroll

</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-and-polish/04-04-SUMMARY.md`
</output>
