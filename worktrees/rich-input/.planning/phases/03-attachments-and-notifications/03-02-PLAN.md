---
phase: 03-attachments-and-notifications
plan: 02
type: execute
wave: 2
depends_on: ["03-01-PLAN.md"]
files_modified:
  - "netlify/functions/send-email.ts"
  - "netlify/functions/comments.ts"
  - "contexts/NotificationContext.tsx"
  - "components/proposals/CommentThread.tsx"
  - "landing-page-new/src/components/CommentThread.tsx"
autonomous: true

must_haves:
  truths:
    - "Users receive email notifications when new comments are posted in their proposal"
    - "In-app notification badge updates when new comments are posted"
    - "Email contains comment preview and link to proposal"
    - "Clicking in-app notification navigates to the proposal with the comment"
    - "Sender does NOT receive notification of their own comment"
  artifacts:
    - path: "netlify/functions/send-email.ts"
      provides: "sendCommentNotificationEmail function"
      exports: ["sendCommentNotificationEmail"]
    - path: "netlify/functions/comments.ts"
      provides: "Triggers email + in-app notifications on comment creation"
    - path: "contexts/NotificationContext.tsx"
      provides: "comment_created notification type and addNotification integration"
    - path: "components/proposals/CommentThread.tsx"
      provides: "Triggers in-app notification after comment submission"
  key_links:
    - from: "comments.ts POST"
      to: "send-email.ts"
      via: "sendCommentNotificationEmail for the other party"
      pattern: "sendCommentNotificationEmail"
    - from: "comments.ts POST"
      to: "notifications.ts"
      via: "POST to create in-app notification record"
      pattern: "POST.*notifications"
    - from: "CommentThread.tsx"
      to: "NotificationContext.tsx"
      via: "addNotification for polling updates"
      pattern: "addNotification.*comment"
---
<objective>
Enable users to receive email and in-app notifications when new comments are posted.

**Purpose:** COMM-04: Email Notifications on Comments & COMM-05: In-App Notifications

**Output:** Working notification system where:
- Superadmin receives email when client posts comment
- Client receives email when superadmin posts comment
- In-app notification appears via NotificationContext
- Clicking notification navigates to proposal
</objective>

<execution_context>
@/Users/praburajasekaran/.claude/get-shit-done/workflows/execute-plan.md
@/Users/praburajasekaran/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-attachments-and-notifications/03-CONTEXT.md

# Existing infrastructure
@netlify/functions/comments.ts
@netlify/functions/send-email.ts
@contexts/NotificationContext.tsx
@components/proposals/CommentThread.tsx
@netlify/functions/_shared/auth.ts

# References for patterns
@netlify/functions/tasks.ts (sendMentionNotification usage)
@netlify/functions/deliverables.ts (email preference check pattern)
</context>

<tasks>

<task type="auto">
  <name>Add sendCommentNotificationEmail function</name>
  <files>netlify/functions/send-email.ts</files>
  <action>
    Add to `netlify/functions/send-email.ts`:
    ```typescript
    export async function sendCommentNotificationEmail(data: {
      to: string;                    // Recipient email
      commenterName: string;         // Name of who posted comment
      commentPreview: string;        // First 100 chars of comment
      proposalId: string;            // For link construction
      proposalNumber?: string;       // Optional - for display
    })
    ```
    Email template following existing patterns (sendMentionNotification style):
    - Subject: "[Client/Admin] commented on your proposal" (use "Client" if commenter role=client, "Admin" otherwise)
    - Greeting with recipient implied (don't use name - email is to=)
    - Preview of comment in blockquote-style box
    - "Reply on Portal" CTA button linking to proposal page
    - Sender: notifications@motionify.studio (from RESEND_FROM_EMAIL env var)
    - No unsubscribe footer (COMM-04: "essential notifications only")
  </action>
  <verify>
    TypeScript compilation passes
  </verify>
  <done>
    sendCommentNotificationEmail function exists and can be imported by comments.ts
  </done>
</task>

<task type="auto">
  <name>Add email notification to comments POST</name>
  <files>netlify/functions/comments.ts</files>
  <action>
    Modify `netlify/functions/comments.ts` POST handler:
    After successfully creating a comment, before returning response:
    1. Query to get the other party (recipient of notification):
       - If commenter is client: find assigned superadmin for this proposal
       - If commenter is superadmin: find client (contact_email) for this proposal
       - Get their email address
    2. Send email notification using sendCommentNotificationEmail
       - Skip if recipient email not found (log warning)
       - Handle email errors gracefully (don't fail the comment creation)
    3. Log success/failure for debugging
    4. Use pattern from tasks.ts (sendTaskAssignmentEmail) for error handling
    Reference the `proposals.ts` function for getting client contact_email from inquiry:
    ```sql
    SELECT i.contact_email, i.contact_name 
    FROM inquiries i 
    JOIN proposals p ON p.inquiry_id = i.id 
    WHERE p.id = $1
    ```
  </action>
  <verify>
    Comments API sends email when new comment is created
  </verify>
  <done>
    New comments trigger email notifications to the other party (sender excluded)
  </done>
</task>

<task type="auto">
  <name>Add in-app notification to comments POST</name>
  <files>netlify/functions/comments.ts</files>
  <action>
    Modify `netlify/functions/comments.ts` POST handler:
    After sending email notification, also create in-app notification:
    1. Check if `notifications` table/function exists (review contexts/NotificationContext.tsx)
    2. If no notifications API, skip (feature will be client-side only for now)
    3. If notifications API exists:
       - POST to create notification record for the recipient
       - Notification type: "comment_created"
       - Include comment preview, proposalId, actionUrl
       - Handle errors gracefully (don't fail comment creation)
    Note: The NotificationContext.addNotification() is client-side; this is the server-side creation.
  </action>
  <verify>
    Comments API creates in-app notification record when notification API exists
  </verify>
  <done>
    In-app notification records are created for new comments
  </done>
</task>

<task type="auto">
  <name>Update NotificationContext for comment notifications</name>
  <files>contexts/NotificationContext.tsx</files>
  <action>
    Modify `contexts/NotificationContext.tsx`:
    1. Add 'comment_created' to NotificationType union
    2. Add 'ðŸ’¬' or 'ðŸ’­' to NOTIFICATION_ICONS for 'comment_created'
    3. Create notification type for comments:
       ```typescript
       interface CommentNotification extends Omit<AppNotification, 'id' | 'timestamp' | 'read'> {
         type: 'comment_created';
         commenterName: string;
         commentPreview: string;
         proposalId: string;
       }
       ```
    4. The addNotification function already exists - it can be called with comment data
    5. Optionally: Add helper function `addCommentNotification(data: CommentNotification)`
    6. No changes needed to fetchNotifications - it already fetches from API
  </action>
  <verify>
    TypeScript compilation passes
    NotificationContext supports 'comment_created' type
  </verify>
  <done>
    NotificationContext can receive and display comment notifications
  </done>
</task>

<task type="auto">
  <name>Trigger in-app notification on client comment submit</name>
  <files>components/proposals/CommentThread.tsx</files>
  <action>
    Modify `components/proposals/CommentThread.tsx`:
    1. Import useNotifications from NotificationContext
    2. In handleSubmit, after successful comment creation:
       - Call addNotification with comment data:
         ```typescript
         addNotification({
           type: 'comment_created',
           title: 'Comment posted',
           message: `Your comment has been posted`,
           commenterName: currentUserName,
           commentPreview: content.substring(0, 100),
           proposalId,
           actionUrl: `/proposal/${proposalId}`,
         });
         ```
       - Note: This shows notification to the sender; for recipient notifications, they come from polling/fetchNotifications
    3. In pollForNewComments, when new comments arrive:
       - For each new comment NOT from current user:
         - Call addNotification with notification data from the polling response
         - Or increment unread count badge
    4. Handle notification click behavior:
       - When user clicks notification, navigate to proposal
       - Highlight the new comment (pass commentId in URL or state)
  </action>
  <verify>
    TypeScript compilation passes
  </verify>
  <done>
    CommentThread triggers in-app notifications when new comments arrive from other users
  </done>
</task>

<task type="auto">
  <name>Update landing-page-new CommentThread</name>
  <files>landing-page-new/src/components/CommentThread.tsx</files>
  <action>
    Apply same notification integration to landing-page-new/src/components/CommentThread.tsx:
    - Import useNotifications from the client portal's NotificationContext
    - Add same notification triggers in handleSubmit and pollForNewComments
    - Adjust imports and paths for Next.js environment
    - Ensure notification URL matches client portal routing (`/proposal/[proposalId]`)
  </action>
  <verify>
    TypeScript compilation passes in landing-page-new
  </verify>
  <done>
    Client portal receives and displays comment notifications
  </done>
</task>

</tasks>

<verification>
1. Email: sendCommentNotificationEmail function exists with proper template
2. Email: New comments trigger email to the other party
3. In-app: NotificationContext supports 'comment_created' type
4. In-app: CommentThread triggers notifications for new comments
5. Both: Sender does not receive their own comment notification
6. Both: Admin and client portals have notification support
</verification>

<success_criteria>
- Client posts comment â†’ Superadmin receives email (not client)
- Superadmin posts comment â†’ Client receives email (not superadmin)
- Email contains first 100 chars of comment and link to proposal
- In-app notification badge updates when comments arrive from other user
- Clicking notification navigates to proposal with comment highlighted
</success_criteria>

<output>
After completion, create `.planning/phases/03-attachments-and-notifications/03-02-SUMMARY.md`
</output>
