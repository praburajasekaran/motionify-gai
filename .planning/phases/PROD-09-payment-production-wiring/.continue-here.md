---
session_id: PROD-09-WEBHOOK-2026-01-28
phase: PROD-09-payment-production-wiring
plan: 02
task: 2
total_tasks: 5
status: checkpoint_pending
last_updated: 2026-01-28
---

<current_state>
PROD-09-02 (E2E Webhook Testing) is at a checkpoint requiring user configuration.

**Critical architectural change made this session:**
The Razorpay webhook was incorrectly located in the Next.js landing page (`landing-page-new/src/app/api/webhooks/razorpay/route.ts`). Since payments happen from the portal at port 5173 (which uses Netlify Functions as backend), the webhook was moved to `netlify/functions/razorpay-webhook.ts`.

**Commit:** `92ca6d3` - refactor(PROD-09): move Razorpay webhook from Next.js to Netlify Functions

The new webhook URL is: `/.netlify/functions/razorpay-webhook`
</current_state>

<completed_work>
- PROD-09-01: Wire Email Notifications into Webhook Handler - COMPLETE (5 tasks, 5 commits)
  - Added sendPaymentSuccessEmail() to send-email.ts
  - Added POST handler for cross-service email calls
  - Created sendPaymentEmails() wrapper in webhook
  - Wired success email into handlePaymentCaptured
  - Wired failure email into handlePaymentFailed
  - Commits: 843651f â†’ f164f5d

- PROD-09-02 Task 1: Verify environment variables - COMPLETE
  - Found RAZORPAY_WEBHOOK_SECRET and ADMIN_NOTIFICATION_EMAIL are missing

- Webhook relocation: Moved from Next.js to Netlify Functions
  - Commit: 92ca6d3
</completed_work>

<remaining_work>
- PROD-09-02 Task 2: Checkpoint - User needs to confirm env vars are set (CURRENT)
- PROD-09-02 Task 3: Checkpoint - User needs to set up ngrok + configure Razorpay webhook
- PROD-09-02 Task 4: Checkpoint - User needs to test payment flow and verify
- PROD-09-02 Task 5: Document test results and production requirements
</remaining_work>

<decisions_made>
- Moved webhook from Next.js to Netlify Functions because payments happen from portal (5173), not landing page
- Email functions are now called directly (not via HTTP fetch) since webhook is in same Netlify context
- Updated project URL to `/#/portal/projects` to match portal routing
</decisions_made>

<blockers>
- User needs to configure environment variables in root `.env`:
  - RAZORPAY_WEBHOOK_SECRET (from Razorpay Dashboard webhook config)
  - ADMIN_NOTIFICATION_EMAIL (for failure notifications)
- User needs to set up ngrok tunnel and configure webhook in Razorpay Dashboard
- New webhook URL: `{base}/.netlify/functions/razorpay-webhook`
</blockers>

<context>
The user corrected my understanding of the architecture:
- There is NO "client portal" - both admin and clients use the same portal at port 5173
- The landing page (purple theme, Next.js) is only for new visitors completing the quiz/inquiry form
- Payments happen from the portal, not the landing page

This means all backend APIs should be in Netlify Functions, not Next.js API routes.
The webhook was in the wrong place and has been fixed.

PROD-09-02 is an E2E testing plan with multiple user checkpoints. It cannot be completed without user action to:
1. Set env vars
2. Set up ngrok
3. Configure webhook in Razorpay Dashboard
4. Run test payments
</context>

<next_action>
When resuming:

1. Ask user if they've configured:
   - `RAZORPAY_WEBHOOK_SECRET` in root `.env`
   - `ADMIN_NOTIFICATION_EMAIL` in root `.env`

2. If yes, proceed to ngrok setup checkpoint

3. If no, guide them:
   ```bash
   # Edit root .env
   nano .env

   # Add:
   RAZORPAY_WEBHOOK_SECRET=<from Razorpay Dashboard>
   ADMIN_NOTIFICATION_EMAIL=your@email.com
   ```

4. Webhook URL for Razorpay Dashboard:
   `{ngrok-url}/.netlify/functions/razorpay-webhook`
</next_action>
