---
phase: 06-schema-alignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/003_align_comments_schema.sql
  - database/add-proposal-comments-table.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Database has author_id column (not user_id) in proposal_comments table"
    - "Database has author_type column with CHECK constraint for CLIENT/ADMIN"
    - "Comment creation via API inserts rows successfully"
    - "Comment editing via API updates rows successfully"
  artifacts:
    - path: "database/migrations/003_align_comments_schema.sql"
      provides: "Schema transformation migration"
      contains: "ALTER TABLE proposal_comments"
    - path: "database/add-proposal-comments-table.sql"
      provides: "Updated Phase 1 schema documentation"
      contains: "author_id"
  key_links:
    - from: "netlify/functions/comments.ts"
      to: "proposal_comments table"
      via: "author_id and author_type columns"
      pattern: "author_id|author_type"
---

<objective>
Align database schema with backend expectations by creating migration 003 to transform proposal_comments table.

Purpose: Fix the critical schema mismatch that blocks comment creation and editing. The backend expects author_id/author_type columns but the database has user_id without author_type.

Output:
- Migration 003 that transforms existing schema using ALTER TABLE
- Updated Phase 1 schema file for documentation consistency
- Working comment create/edit functionality
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-schema-alignment/06-RESEARCH.md
@database/migrations/002_add_comments_and_notifications.sql
@database/add-proposal-comments-table.sql
@netlify/functions/comments.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Migration 003 for Schema Alignment</name>
  <files>database/migrations/003_align_comments_schema.sql</files>
  <action>
Create migration file `003_align_comments_schema.sql` following the existing migration pattern.

The migration must:

**UP Section:**
1. Check if `user_id` column exists, if so rename it to `author_id` using ALTER TABLE RENAME COLUMN
2. Check if `author_type` column doesn't exist, if so:
   - Add `author_type VARCHAR(20)` as nullable first (fast, no table rewrite)
   - Backfill existing rows by joining with users table: if user.role = 'client' then 'CLIENT' else 'ADMIN'
   - Make column NOT NULL
   - Add CHECK constraint for ('CLIENT', 'ADMIN') values

Use DO $$ blocks with conditional checks (information_schema.columns) for idempotency - migration should be safe to run even if schema is already correct.

**DOWN Section:**
1. Drop CHECK constraint if exists
2. Drop author_type column if exists
3. Rename author_id back to user_id if author_id exists

Reference the code example from 06-RESEARCH.md for the complete SQL structure.

Do NOT use CREATE TABLE IF NOT EXISTS (that's migration 002's approach which doesn't fix existing tables). Use ALTER TABLE exclusively.
  </action>
  <verify>
File exists at `database/migrations/003_align_comments_schema.sql` with:
- `-- UP` section with ALTER TABLE statements
- `-- DOWN` section with rollback statements
- Conditional logic using information_schema.columns
- Both author_id rename and author_type add operations
  </verify>
  <done>Migration 003 file created with idempotent ALTER TABLE operations for UP and DOWN migrations</done>
</task>

<task type="auto">
  <name>Task 2: Update Phase 1 Schema Documentation File</name>
  <files>database/add-proposal-comments-table.sql</files>
  <action>
Update `database/add-proposal-comments-table.sql` to match the correct schema for documentation consistency.

Replace the current schema with:
- `author_id UUID NOT NULL` (instead of user_id)
- `author_type VARCHAR(20) NOT NULL CHECK (author_type IN ('CLIENT', 'ADMIN'))` (new column)
- Keep existing columns: id, proposal_id, content, user_name, is_edited, created_at, updated_at
- Keep existing indexes but update user_id index to author_id

This file is for documentation purposes (Phase 1 reference). The actual schema transformation is handled by migration 003.

Add a comment at the top noting this file documents the final schema after all migrations are applied.
  </action>
  <verify>
File contains:
- `author_id UUID NOT NULL` column
- `author_type VARCHAR(20) NOT NULL` column with CHECK constraint
- `idx_proposal_comments_author_id` index (renamed from user_id)
- Documentation comment explaining this is the final schema state
  </verify>
  <done>Phase 1 schema file updated to reflect correct column names matching backend expectations</done>
</task>

<task type="auto">
  <name>Task 3: Apply Migration and Verify Schema</name>
  <files>N/A - Database operation</files>
  <action>
Run the migration using the existing migration runner:

```bash
# Check current migration status
npm run db:migrate:status

# Apply pending migrations (including 003)
npm run db:migrate

# Verify migration applied
npm run db:migrate:status
```

After migration, verify the schema is correct by querying information_schema:

```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'proposal_comments'
  AND column_name IN ('author_id', 'author_type', 'user_id')
ORDER BY ordinal_position;
```

Expected result:
- author_id | uuid | NO
- author_type | character varying | NO
- user_id should NOT exist

Also verify the CHECK constraint exists:
```sql
SELECT constraint_name, check_clause
FROM information_schema.check_constraints
WHERE constraint_name = 'check_author_type';
```

If the database doesn't have the proposal_comments table yet, migration 002 will create it with correct schema, and migration 003 will be a no-op (idempotent).

If any migration fails, check the error message and fix. Common issues:
- Table doesn't exist: Apply migration 002 first
- Column already correct: Migration 003 should handle this with conditional checks
- Backfill fails: Users table might not have all author IDs
  </action>
  <verify>
1. `npm run db:migrate:status` shows migration 003 as applied
2. Schema query returns author_id and author_type columns (no user_id)
3. CHECK constraint check_author_type exists
4. No errors in migration output
  </verify>
  <done>Migration 003 applied successfully, database schema matches backend expectations with author_id and author_type columns</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Schema Verification:**
   - Run: `npm run db:migrate:status`
   - Expected: All migrations (001, 002, 003) show as applied

2. **Column Verification:**
   - Query information_schema.columns for proposal_comments table
   - Confirm author_id and author_type exist, user_id does not

3. **API Verification (optional manual test):**
   - POST to /api/comments with valid payload
   - Expected: 200/201 response, comment created with author_id and author_type
   - PUT to /api/comments/{id} to edit
   - Expected: 200 response, comment updated

4. **Build Verification:**
   - Run: `npm run build` (both admin and client portals)
   - Expected: No errors (TypeScript/API compatibility maintained)
</verification>

<success_criteria>
1. Migration 003 exists and applies without errors
2. Database proposal_comments table has author_id and author_type columns
3. Database proposal_comments table does NOT have user_id column
4. Phase 1 schema file updated to match current schema
5. Comments API endpoints work (POST creates, PUT updates)
</success_criteria>

<output>
After completion, create `.planning/phases/06-schema-alignment/06-01-SUMMARY.md`
</output>
