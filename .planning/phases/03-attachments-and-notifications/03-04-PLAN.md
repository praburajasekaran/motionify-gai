---
phase: 03-attachments-and-notifications
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - netlify/functions/r2-presign.ts
  - netlify/functions/comments.ts
  - netlify/functions/attachments.ts
  - netlify/functions/notifications.ts
autonomous: true
gap_closure: true
user_setup:
  - service: database
    why: "Schema migration required"
    env_vars:
      - name: DATABASE_URL
        source: "Supabase Dashboard"
  - service: r2
    why: "File upload storage"
    env_vars:
      - name: R2_ACCOUNT_ID
        source: "Cloudflare Dashboard"

must_haves:
  truths:
    - "API endpoints return CORS headers on 500/400 errors"
    - "DB connection failures are caught gracefully"
    - "UUID validation accepts standard UUID formats"
  artifacts:
    - path: "netlify/functions/r2-presign.ts"
      provides: "Robust presigned URL generation"
    - path: "netlify/functions/comments.ts"
      provides: "Safe comment creation"
  key_links:
    - from: "Frontend"
      to: "/.netlify/functions/r2-presign"
      via: "CORS preflight"
---

<objective>
Fix blocking backend infrastructure issues preventing file uploads and causing API instability.
Focus on CORS reliability, database connection safety, and validation logic.

Purpose: Enable frontend to successfully communicate with backend APIs without CORS blocks or 500 crashes.
Output: Robust Netlify Functions that handle errors gracefully and permit cross-origin requests.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-attachments-and-notifications/03-UAT.md
@netlify/functions/r2-presign.ts
@netlify/functions/comments.ts
@netlify/functions/attachments.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CORS and Error Handling in R2 Presign</name>
  <files>netlify/functions/r2-presign.ts</files>
  <action>
    Update `netlify/functions/r2-presign.ts` to ensure CORS headers are present in ALL responses:
    1. Define `headers` object with CORS values at the top.
    2. Use this `headers` object in every `return new Response(...)`, especially for 400 (Missing 'key') and 500 (Missing env vars) errors.
    3. Ensure `Access-Control-Allow-Origin: *` is set.
    4. Currently, the "Missing R2 environment variables" check returns a 500 with NO CORS headers, which causes the browser to report a CORS error instead of the actual error message. Fix this.
  </action>
  <verify>
    grep "Access-Control-Allow-Origin" netlify/functions/r2-presign.ts
  </verify>
  <done>
    All return statements include CORS headers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Database Connection Safety</name>
  <files>netlify/functions/comments.ts, netlify/functions/attachments.ts</files>
  <action>
    In `netlify/functions/comments.ts` and `netlify/functions/attachments.ts`:
    1. Move the `const client = getDbClient();` call INSIDE the `try` block.
    2. Currently, `getDbClient` throws an error if `DATABASE_URL` is missing *before* the try/catch, causing an unhandled crash (502/500) without CORS headers.
    3. Ensure that if `getDbClient` fails, it is caught by the `catch` block and returns a 500 WITH CORS headers.
  </action>
  <verify>
    grep -A 5 "try {" netlify/functions/comments.ts | grep "getDbClient"
  </verify>
  <done>
    DB client initialization is wrapped in error handling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Relax UUID Validation</name>
  <files>netlify/functions/notifications.ts</files>
  <action>
    Check `netlify/functions/notifications.ts` for UUID validation logic.
    1. If using a strict regex that fails on valid UUIDs (e.g. case sensitivity issues), replace it with a standard permissive UUID regex (e.g., `^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$`).
    2. Ensure `isValidUUID` function is robust.
  </action>
  <verify>
    cat netlify/functions/notifications.ts
  </verify>
  <done>
    UUID validation accepts standard UUID formats (lowercase/uppercase).
  </done>
</task>

<task type="auto">
  <name>Task 4: Sync Database Schema</name>
  <files>prisma/schema.prisma</files>
  <action>
    Run `npx prisma db push` to ensure the database schema matches the local Prisma schema.
    This addresses the UAT gap "Missing DB migration" which suspected schema drift as a cause for 500 errors.
  </action>
  <verify>
    npx prisma db push --preview-feature
  </verify>
  <done>
    Database schema is synchronized.
  </done>
</task>

</tasks>

<verification>
Check that all modified functions have proper error handling and CORS headers.
</verification>

<success_criteria>
- [ ] R2 presign endpoint returns JSON error (not CORS error) when config is missing
- [ ] Comments endpoint catches DB connection errors gracefully
- [ ] Notifications endpoint accepts valid UUIDs
- [ ] Database schema is up to date
</success_criteria>

<output>
After completion, create `.planning/phases/03-attachments-and-notifications/03-04-SUMMARY.md`
</output>
