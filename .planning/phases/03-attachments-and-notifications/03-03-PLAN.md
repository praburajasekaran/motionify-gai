---
phase: 03-attachments-and-notifications
plan: 03
type: execute
wave: 1
depends_on: ["03-02-PLAN.md"]
files_modified:
  - "landing-page-new/src/contexts/NotificationContext.tsx"
  - "landing-page-new/src/app/layout.tsx"
  - "landing-page-new/src/components/CommentThread.tsx"
  - "landing-page-new/src/lib/portal/components/NotificationBell.tsx"
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "In-app notification badge updates when new comments are posted"
    - "Clicking in-app notification navigates to the proposal with the comment"
    - "Client portal users see notification bell with unread count"
    - "Polling for new comments triggers local notification for comments from other users"
  artifacts:
    - path: "landing-page-new/src/contexts/NotificationContext.tsx"
      provides: "NotificationContext with useNotifications hook for client portal"
      exports: ["NotificationProvider", "useNotifications", "NotificationType", "AppNotification"]
    - path: "landing-page-new/src/app/layout.tsx"
      provides: "NotificationProvider wrapping the app"
      contains: "NotificationProvider"
    - path: "landing-page-new/src/components/CommentThread.tsx"
      provides: "Notification integration via useNotifications and addNotification"
      contains: "useNotifications"
    - path: "landing-page-new/src/lib/portal/components/NotificationBell.tsx"
      provides: "Updated to use NotificationContext instead of AppContext"
      contains: "useNotifications"
  key_links:
    - from: "landing-page-new/src/components/CommentThread.tsx"
      to: "landing-page-new/src/contexts/NotificationContext.tsx"
      via: "useNotifications hook for addNotification"
      pattern: "addNotification.*comment_created"
    - from: "landing-page-new/src/lib/portal/components/NotificationBell.tsx"
      to: "landing-page-new/src/contexts/NotificationContext.tsx"
      via: "useNotifications for notifications and unreadCount"
      pattern: "useNotifications"
    - from: "landing-page-new/src/app/layout.tsx"
      to: "landing-page-new/src/contexts/NotificationContext.tsx"
      via: "NotificationProvider wrapping children"
      pattern: "NotificationProvider"
---

<objective>
Close verification gaps for COMM-05: In-App Notifications in the client portal.

**Purpose:** The admin portal has working notification infrastructure (NotificationContext, NotificationBell, CommentThread integration). The client portal lacks this infrastructure entirely. This plan ports the notification system to the client portal.

**Gap Source:** `03-VERIFICATION.md` - 2 failed truths:
1. "In-app notification badge updates when new comments are posted" - No NotificationContext in client portal
2. "Clicking in-app notification navigates to the proposal with the comment" - Cannot integrate without NotificationContext

**Output:** Working in-app notifications in client portal matching admin portal behavior.
</objective>

<execution_context>
@/Users/praburajasekaran/.claude/get-shit-done/workflows/execute-plan.md
@/Users/praburajasekaran/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/03-attachments-and-notifications/03-VERIFICATION.md

# Admin portal working patterns (copy these to client)
@contexts/NotificationContext.tsx
@components/proposals/CommentThread.tsx
@components/notifications/NotificationBell.tsx

# Client portal files to modify
@landing-page-new/src/app/layout.tsx
@landing-page-new/src/components/CommentThread.tsx
@landing-page-new/src/lib/portal/components/NotificationBell.tsx
@landing-page-new/src/context/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotificationContext for client portal</name>
  <files>landing-page-new/src/contexts/NotificationContext.tsx</files>
  <action>
    Create `landing-page-new/src/contexts/NotificationContext.tsx` by adapting `contexts/NotificationContext.tsx`:

    1. Copy the admin NotificationContext structure
    2. Adjust for Next.js:
       - Add `'use client';` directive at top
       - Use `useAuth` from `@/context/AuthContext` instead of `useAuthContext`
       - Change API_BASE to `process.env.NEXT_PUBLIC_API_URL || '/.netlify/functions'`
    3. Keep all types and exports:
       - `NotificationType` union type
       - `NOTIFICATION_ICONS` record
       - `AppNotification` interface
       - `NotificationProvider` component
       - `useNotifications` hook
    4. Ensure `addNotification` creates local notifications (for polling updates)
    5. Ensure `fetchNotifications` pulls from `/notifications` API
    6. Add polling for new notifications (every 30 seconds) similar to admin

    Key differences from admin:
    - `useAuth` hook returns `{ user }` where user has `id` property
    - API calls should use the same base URL pattern as other client API calls
  </action>
  <verify>
    `npm run build` passes in landing-page-new directory
    File exports NotificationProvider and useNotifications
  </verify>
  <done>
    NotificationContext.tsx exists in landing-page-new/src/contexts/ with all required exports
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate NotificationProvider in client portal layout</name>
  <files>landing-page-new/src/app/layout.tsx</files>
  <action>
    Modify `landing-page-new/src/app/layout.tsx`:

    1. Import NotificationProvider from `@/contexts/NotificationContext`
    2. Wrap children with NotificationProvider INSIDE AuthProvider:
       ```tsx
       <AuthProvider>
         <NotificationProvider>
           {children}
         </NotificationProvider>
       </AuthProvider>
       ```

    Why inside AuthProvider: NotificationContext needs user.id from AuthContext to fetch user-specific notifications.
  </action>
  <verify>
    `npm run build` passes in landing-page-new directory
    Layout wraps app with NotificationProvider
  </verify>
  <done>
    NotificationProvider is integrated in the app layout, nested inside AuthProvider
  </done>
</task>

<task type="auto">
  <name>Task 3: Update client CommentThread to trigger notifications</name>
  <files>landing-page-new/src/components/CommentThread.tsx</files>
  <action>
    Modify `landing-page-new/src/components/CommentThread.tsx`:

    1. Import useNotifications from `@/contexts/NotificationContext`
    2. Get addNotification from the hook:
       ```tsx
       const { addNotification } = useNotifications();
       ```
    3. In pollForNewComments, after detecting trulyNew comments, add notification for comments from other users:
       ```tsx
       // Inside setComments callback, after determining trulyNew
       trulyNew.forEach(comment => {
           if (comment.userId !== currentUserId) {
               addNotification({
                   type: 'comment_created',
                   title: 'New Comment',
                   message: `${comment.userName} commented on the proposal`,
                   actionUrl: `/proposal/${proposalId}`,
                   projectId: proposalId,
               });
           }
       });
       ```

    This matches the exact pattern used in admin CommentThread (lines 90-100).
  </action>
  <verify>
    `npm run build` passes in landing-page-new directory
    CommentThread imports and uses useNotifications
  </verify>
  <done>
    Client CommentThread triggers in-app notifications when new comments arrive from other users
  </done>
</task>

<task type="auto">
  <name>Task 4: Update client NotificationBell to use NotificationContext</name>
  <files>landing-page-new/src/lib/portal/components/NotificationBell.tsx</files>
  <action>
    Modify `landing-page-new/src/lib/portal/components/NotificationBell.tsx`:

    Currently uses AppContext (mock data). Update to use NotificationContext (real data):

    1. Replace AppContext import with NotificationContext:
       ```tsx
       // Remove: import { AppContext } from '@/lib/portal/AppContext';
       // Add:
       import { useNotifications } from '@/contexts/NotificationContext';
       ```

    2. Replace useContext(AppContext) with useNotifications():
       ```tsx
       // Remove:
       // const { notifications, markNotificationAsRead, markNotificationsAsRead } = useContext(AppContext);

       // Add:
       const { notifications, unreadCount, markAsRead, markAllAsRead } = useNotifications();
       ```

    3. Update function calls to match NotificationContext API:
       - `markNotificationAsRead(id)` -> `markAsRead(id)`
       - `markNotificationsAsRead()` -> `markAllAsRead()`
       - Use `unreadCount` directly instead of computing from notifications.filter()

    4. Update notification type cast - NotificationContext uses `AppNotification` type:
       ```tsx
       import type { AppNotification } from '@/contexts/NotificationContext';
       // Cast: const typedNotifications = notifications as AppNotification[];
       ```
       Or better: remove the cast entirely since NotificationContext already returns properly typed notifications.

    5. Keep all existing UI (bell icon, badge, dropdown) unchanged.
  </action>
  <verify>
    `npm run build` passes in landing-page-new directory
    NotificationBell uses useNotifications hook
  </verify>
  <done>
    NotificationBell displays real notifications from NotificationContext instead of mock AppContext data
  </done>
</task>

</tasks>

<verification>
1. NotificationContext.tsx exists at `landing-page-new/src/contexts/NotificationContext.tsx`
2. NotificationContext exports: NotificationProvider, useNotifications, NotificationType, AppNotification
3. layout.tsx wraps app with NotificationProvider (inside AuthProvider)
4. CommentThread.tsx imports useNotifications and calls addNotification for new comments
5. NotificationBell.tsx uses useNotifications instead of AppContext
6. `npm run build` passes for both admin (Vite) and client (Next.js) portals
</verification>

<success_criteria>
- Client portal has NotificationContext with fetchNotifications and addNotification
- NotificationProvider wraps the client portal app
- When User A posts a comment, User B's notification badge updates (via polling + addNotification)
- Clicking a notification navigates to `/proposal/{proposalId}`
- Both portals build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-attachments-and-notifications/03-03-SUMMARY.md`
</output>
