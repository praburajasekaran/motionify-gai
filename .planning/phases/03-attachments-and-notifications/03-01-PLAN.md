---
phase: 03-attachments-and-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - "database/add-comment-attachments-table.sql"
  - "netlify/functions/attachments.ts"
  - "lib/attachments.ts"
  - "components/proposals/CommentInput.tsx"
  - "components/proposals/CommentItem.tsx"
  - "landing-page-new/src/components/CommentInput.tsx"
  - "landing-page-new/src/components/CommentItem.tsx"
autonomous: true

must_haves:
  truths:
    - "Users can attach files to comments using the existing R2 presign infrastructure"
    - "Uploaded files display as attachments in the comment thread"
    - "Both parties can download attached files"
    - "File uploads respect allowed types (PNG, JPG, WebP, PDF, DOCX, DOC, TXT) and 10MB size limit"
  artifacts:
    - path: "database/add-comment-attachments-table.sql"
      provides: "Comment attachment records with file metadata"
      min_lines: 30
    - path: "netlify/functions/attachments.ts"
      provides: "Attachment CRUD operations linked to comments"
      exports: ["GET", "POST"]
    - path: "lib/attachments.ts"
      provides: "Client functions for attachment uploads/downloads"
    - path: "components/proposals/CommentInput.tsx"
      provides: "File upload UI with progress state"
    - path: "components/proposals/CommentItem.tsx"
      provides: "Attachment display and download links"
  key_links:
    - from: "CommentInput.tsx"
      to: "r2-presign.ts"
      via: "Presigned URL upload for files"
      pattern: "uploadUrl.*r2-presign"
    - from: "CommentItem.tsx"
      to: "attachments.ts"
      via: "GET endpoint for attachment list"
      pattern: "getAttachments.*proposalId"
    - from: "CommentItem.tsx"
      to: "r2-presign.ts"
      via: "Download URL generation"
      pattern: "downloadUrl.*r2-presign"
---

<objective>
Enable users to attach files to comments using the existing R2 presigned URL infrastructure.

**Purpose:** COMM-03: File Attachments on Comments - Users can attach files to comments that both parties can view and download.

**Output:** Working file attachment feature with:
- Database table for attachment metadata
- API endpoints for attachment management
- File upload UI in comment input
- Attachment display in comment items
</objective>

<execution_context>
@/Users/praburajasekaran/.claude/get-shit-done/workflows/execute-plan.md
@/Users/praburajasekaran/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-attachments-and-notifications/03-CONTEXT.md

# Existing infrastructure to leverage
@netlify/functions/r2-presign.ts
@netlify/functions/comments.ts
@lib/comments.ts
@components/proposals/CommentThread.tsx
@components/proposals/CommentInput.tsx
@components/proposals/CommentItem.tsx
</context>

<tasks>

<task type="auto">
  <name>Create comment_attachments database table</name>
  <files>database/add-comment-attachments-table.sql</files>
  <action>
    Create SQL migration file with:
    - Table `comment_attachments` with columns:
      - `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
      - `comment_id` UUID NOT NULL REFERENCES proposal_comments(id) ON DELETE CASCADE
      - `file_name` VARCHAR(255) NOT NULL
      - `file_type` VARCHAR(100) NOT NULL
      - `file_size` INTEGER NOT NULL (in bytes)
      - `r2_key` VARCHAR(512) NOT NULL (R2 storage key)
      - `uploaded_by` UUID NOT NULL
      - `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    - Index on `comment_id` for efficient queries
    - Index on `uploaded_by` for user lookups
    - Review `database/add-proposal-comments-table.sql` for table naming conventions
  </action>
  <verify>
    sqlc generate (if used) or psql check: `\d comment_attachments` shows all columns and indexes
  </verify>
  <done>
    Comment attachments table exists with proper schema, indexes, and foreign key to proposal_comments
  </done>
</task>

<task type="auto">
  <name>Implement attachments API endpoints</name>
  <files>netlify/functions/attachments.ts</files>
  <action>
    Create new Netlify function `attachments.ts` with:
    - GET endpoint: Fetch attachments for a comment (requires auth)
      - Query param: `commentId`
      - Returns array of attachment objects with metadata (no R2 key exposed)
    - POST endpoint: Create attachment record after successful upload (requires auth)
      - Body: `{ commentId, fileName, fileType, fileSize, r2Key }`
      - Validates fileName length <= 255 chars
      - Validates fileType against allowlist: image/png, image/jpeg, image/webp, application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document, text/plain
      - Validates fileSize <= 10MB (10485760 bytes)
      - Inserts into comment_attachments table
      - Returns attachment object with id
    - All endpoints: require auth via `requireAuth`
    - CORS headers same as comments.ts
    - Handle database errors gracefully
    - Use same error response format as comments.ts
  </action>
  <verify>
    curl -X GET "https://.../.netlify/functions/attachments?commentId=xxx" returns 401 without auth
    curl -X POST with valid data returns 201 with attachment object
  </verify>
  <done>
    Attachments API handles GET (list by comment) and POST (create record) with proper validation and auth
  </done>
</task>

<task type="auto">
  <name>Create attachments client library</name>
  <files>lib/attachments.ts</files>
  <action>
    Create new file `lib/attachments.ts` with:
    - Export `Attachment` interface matching API response (id, commentId, fileName, fileType, fileSize, uploadedBy, createdAt)
    - Export `UploadAttachmentData` interface (fileName, fileType, fileSize, file, proposalId)
    - Export `getAttachments(commentId: string): Promise<Attachment[]>`
      - GET request to `/.netlify/functions/attachments?commentId={commentId}`
      - Returns empty array on error
    - Export `createAttachment(data): Promise<Attachment | null>`
      - POST to `/.netlify/functions/attachments`
      - Returns null on error
    - Export `getPresignedUploadUrl(fileName, fileType, projectId): Promise<{uploadUrl, key}>`
      - Calls existing `/.netlify/api/r2-presign` POST endpoint
      - Returns null on error
    - Export `getPresignedDownloadUrl(key): Promise<string | null>`
      - Calls existing `/.netlify/api/r2-presign` GET endpoint
      - Returns null on error
    - Export `async uploadFile(uploadUrl, file): Promise<boolean>`
      - PUT request with file content to presigned URL
      - Returns true on success, false on error
  </action>
  <verify>
    TypeScript compilation passes with no errors
  </verify>
  <done>
    Client library provides functions for attachment CRUD and presigned URL operations
  </done>
</task>

<task type="auto">
  <name>Update CommentInput with file upload UI</name>
  <files>components/proposals/CommentInput.tsx</files>
  <action>
    Modify `components/proposals/CommentInput.tsx`:
    - Add file upload button (paperclip icon from lucide-react)
    - Add state for `uploadingFiles: { id: string, file: File, progress: number }[]`
    - Add state for `attachments: Attachment[]`
    - Implement file selection handler:
      - Validate file type against allowlist (PNG, JPG, WebP, PDF, DOCX, DOC, TXT)
      - Validate file size <= 10MB
      - Show error toast for invalid files (use existing toast pattern)
    - Implement upload flow:
      1. Get presigned upload URL from r2-presign API
      2. Upload file to R2 using presigned URL
      3. Create attachment record via attachments API
      4. Add to attachments array
      5. Show progress during upload
    - Display attached files below input with:
      - File name (truncated if > 30 chars)
      - File size (formatted KB/MB)
      - Remove button (X) to cancel upload or remove existing
    - Update onSubmit to include attachment IDs in comment creation
    - Remove attachments from comment when comment is removed (handled by CASCADE)
    - Style: Match existing CommentInput styling, use appropriate icon sizes
  </action>
  <verify>
    TypeScript compilation passes
    CommentInput shows file picker, displays uploads, handles errors gracefully
  </verify>
  <done>
    CommentInput allows selecting files, uploading to R2 via presigned URL, and displays uploaded attachments
  </done>
</task>

<task type="auto">
  <name>Update CommentItem to display attachments</name>
  <files>components/proposals/CommentItem.tsx</files>
  <action>
    Modify `components/proposals/CommentItem.tsx`:
    - Import `Attachment` type from lib/attachments
    - Add state or prop for `attachments?: Attachment[]`
    - Add `loadAttachments` effect to fetch attachments for this comment
    - Add UI below comment content to display attachments:
      - Use file type icons from lucide-react (FileText, FileImage, etc.)
      - Show file name (clickable for download)
      - Show file size formatted
      - On click: get presigned download URL and trigger download
      - Handle download errors gracefully (show toast)
    - Handle loading state for attachments
    - Style: Use existing comment styling, appropriate spacing, hover states
  </action>
  <verify>
    TypeScript compilation passes
    CommentItem shows download links for attachments
  </verify>
  <done>
    CommentItem displays attachment list with working download functionality
  </done>
</task>

<task type="auto">
  <name>Update landing-page-new CommentInput and CommentItem</name>
  <files>landing-page-new/src/components/CommentInput.tsx, landing-page-new/src/components/CommentItem.tsx</files>
  <action>
    Apply same changes as tasks 4 and 5 to the landing-page-new versions:
    - `landing-page-new/src/components/CommentInput.tsx` - add file upload UI
    - `landing-page-new/src/components/CommentItem.tsx` - add attachment display
    - Ensure imports work in Next.js environment (adjust paths if needed)
    - Use same file upload logic and attachment display patterns
  </action>
  <verify>
    TypeScript compilation passes in landing-page-new
  </verify>
  <done>
    Client portal has same file attachment functionality as admin portal
  </done>
</task>

</tasks>

<verification>
1. Database: `comment_attachments` table exists with proper schema
2. API: GET /attachments returns attachments for a comment (auth required)
3. API: POST /attachments creates attachment record with validation
4. Client: lib/attachments.ts exports all required functions
5. UI: CommentInput shows file upload button and displays uploads
6. UI: CommentItem displays attachments with working downloads
7. Both admin and client portals have attachment support
</verification>

<success_criteria>
- Users can attach PNG, JPG, WebP, PDF, DOCX, DOC, TXT files up to 10MB
- Files upload via existing R2 presigned URL infrastructure
- Uploaded files display in comment thread with file name and size
- Both parties can download attachments
- File validation errors show appropriate feedback
</success_criteria>

<output>
After completion, create `.planning/phases/03-attachments-and-notifications/03-01-SUMMARY.md`
</output>
