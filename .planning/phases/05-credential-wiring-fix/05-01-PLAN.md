---
phase: 05-credential-wiring-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - landing-page-new/src/components/CommentThread.tsx
  - contexts/NotificationContext.tsx
autonomous: true

must_haves:
  truths:
    - "Client portal users can edit their own comments"
    - "Admin portal notification badge shows correct unread count on page load"
    - "Admin portal mark-as-read updates notification state"
    - "Admin portal mark-all-as-read clears unread count"
  artifacts:
    - path: "landing-page-new/src/components/CommentThread.tsx"
      provides: "Cookie-authenticated comment editing"
      contains: "credentials: 'include'"
    - path: "contexts/NotificationContext.tsx"
      provides: "Cookie-authenticated notification API calls"
      contains: "credentials: 'include'"
  key_links:
    - from: "landing-page-new/src/components/CommentThread.tsx"
      to: "/comments PUT endpoint"
      via: "fetch with credentials: 'include'"
      pattern: "method:\\s*'PUT'[\\s\\S]*?credentials:\\s*'include'"
    - from: "contexts/NotificationContext.tsx"
      to: "/notifications GET endpoint"
      via: "fetch with credentials: 'include'"
      pattern: "notifications\\?userId[\\s\\S]*?credentials:\\s*'include'"
    - from: "contexts/NotificationContext.tsx"
      to: "/notifications PATCH endpoint"
      via: "fetch with credentials: 'include'"
      pattern: "method:\\s*'PATCH'[\\s\\S]*?credentials:\\s*'include'"
---

<objective>
Add `credentials: 'include'` to 4 fetch calls that were missed during PROD-01 security hardening.

Purpose: Fix 401 Unauthorized errors on comment editing (client portal) and notification operations (admin portal) caused by missing cookie authentication headers.

Output: Both portals successfully authenticate API calls using httpOnly cookies.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix client portal comment editing authentication</name>
  <files>landing-page-new/src/components/CommentThread.tsx</files>
  <action>
Add `credentials: 'include'` to the handleEdit function's fetch call.

Current code (lines 262-268):
```typescript
const handleEdit = async (id: string, newContent: string) => {
    const response = await fetch(`${API_BASE}/comments`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id, content: newContent }),
    });
```

Updated code:
```typescript
const handleEdit = async (id: string, newContent: string) => {
    const response = await fetch(`${API_BASE}/comments`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({ id, content: newContent }),
    });
```

Add `credentials: 'include'` after the headers object, before the body.
  </action>
  <verify>
Run: `cd landing-page-new && npm run build`
Build passes without errors.
  </verify>
  <done>handleEdit fetch includes credentials: 'include', client portal can edit comments with cookie auth</done>
</task>

<task type="auto">
  <name>Task 2: Fix admin portal notification API authentication</name>
  <files>contexts/NotificationContext.tsx</files>
  <action>
Add `credentials: 'include'` to 3 fetch calls in NotificationContext.tsx:

1. **fetchNotifications (line 87)** - GET request:
Current:
```typescript
const response = await fetch(`${API_BASE}/notifications?userId=${user.id}`);
```
Updated:
```typescript
const response = await fetch(`${API_BASE}/notifications?userId=${user.id}`, {
    credentials: 'include',
});
```

2. **markAsRead (lines 114-118)** - PATCH request:
Current:
```typescript
await fetch(`${API_BASE}/notifications`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId: user.id, notificationId: id }),
});
```
Updated:
```typescript
await fetch(`${API_BASE}/notifications`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ userId: user.id, notificationId: id }),
});
```

3. **markAllAsRead (lines 133-137)** - PATCH request:
Current:
```typescript
await fetch(`${API_BASE}/notifications?markAll=true`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId: user.id }),
});
```
Updated:
```typescript
await fetch(`${API_BASE}/notifications?markAll=true`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ userId: user.id }),
});
```

For each PATCH request, add `credentials: 'include'` after headers and before body.
  </action>
  <verify>
Run: `npm run build`
Vite build passes without errors.
  </verify>
  <done>All 3 notification fetch calls include credentials: 'include', admin portal notifications work with cookie auth</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Grep for credentials pattern in modified files:**
   ```bash
   grep -n "credentials: 'include'" landing-page-new/src/components/CommentThread.tsx
   grep -n "credentials: 'include'" contexts/NotificationContext.tsx
   ```
   Expected: CommentThread shows 3 matches (GET, POST, PUT), NotificationContext shows 3 matches (GET, PATCH x2)

2. **Both builds pass:**
   - Client portal: `cd landing-page-new && npm run build` (Next.js)
   - Admin portal: `npm run build` (Vite)

3. **No TypeScript errors:**
   - `cd landing-page-new && npx tsc --noEmit`
   - `npx tsc --noEmit`
</verification>

<success_criteria>
1. Client portal comment editing returns 200 (not 401) when user edits their comment
2. Admin portal notifications fetch on page load returns 200 (not 401)
3. Admin portal mark-as-read and mark-all-as-read return 200 (not 401)
4. Both portal builds pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-credential-wiring-fix/05-01-SUMMARY.md`
</output>
