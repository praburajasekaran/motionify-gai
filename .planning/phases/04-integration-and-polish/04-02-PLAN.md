---
phase: 04-integration-and-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/002_add_comments_and_notifications.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Comments API returns successful 200 responses without 500 errors"
    - "Database schema matches Phase 03 code expectations (author_id, author_type columns exist)"
    - "Existing comments can be fetched via GET /api/comments"
  artifacts:
    - path: "database/migrations/002_add_comments_and_notifications.sql"
      provides: "Schema migration for comments table"
      contains: "author_id"
    - path: "netlify/functions/comments.ts"
      provides: "Comments API using author_id/author_type columns"
      pattern: "author_id"
  key_links:
    - from: "netlify/functions/comments.ts"
      to: "proposal_comments table"
      via: "SQL queries"
      pattern: "author_id|author_type"
---

<objective>
Apply database migration 002 to update proposal_comments table schema from Phase 01 (user_id) to Phase 03 (author_id, author_type), eliminating 500 errors from API queries.

Purpose: Code expects Phase 03 schema but database still has Phase 01 schema, causing column mismatch errors.
Output: Migration applied, API queries return 200 responses, no schema mismatches.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-and-polish/04-UAT.md

## Root Cause (from UAT diagnosis)

User reported 500 error:
```
GET http://localhost:9999/.netlify/functions/comments?proposalId=09cafe3a-18e9-4657-9c0e-51b5fe73e2f2 500 (Internal Server Error)
Failed to fetch comments: undefined
```

**Diagnosis:** Database migration 002 was never executed. Database has Phase 01 schema (user_id) while code expects Phase 03 schema (author_id, author_type). SQL queries in comments.ts reference columns that don't exist.

**Gap artifacts:**
- `database/migrations/002_add_comments_and_notifications.sql` - Migration file exists but never run
- `netlify/functions/comments.ts` - Lines 82-92 (GET) and 185-197 (POST) query non-existent columns

**Fix:** Run migration to align database with code.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply database migration 002</name>
  <files>database/migrations/002_add_comments_and_notifications.sql</files>
  <action>
Run the database migration using the migration tooling:

```bash
npx tsx database/migrate.ts up
```

This will execute migration 002 which:
- Adds author_id and author_type columns to proposal_comments
- Migrates data from user_id to author_id (setting author_type appropriately)
- Drops user_id column after migration
- Creates notifications table if missing
- Creates comment_attachments table if missing

**Important:** The migration file already exists and contains the correct schema transformations. Do not modify the SQL - just execute it.

After migration completes, verify it was applied:

```bash
npx tsx database/migrate.ts status
```

Expected output: Migration 002 shows as "applied" or "up".
  </action>
  <verify>
1. `npx tsx database/migrate.ts status` shows migration 002 applied
2. Test API endpoint: `curl "http://localhost:9999/.netlify/functions/comments?proposalId=<valid-uuid>"` returns 200 (not 500)
3. Check database schema directly if needed: Query proposal_comments table to confirm author_id and author_type columns exist
  </verify>
  <done>
Migration 002 applied successfully. Comments API returns 200 responses. Database schema matches code expectations.
  </done>
</task>

</tasks>

<verification>

**Schema alignment verified:**
```bash
# Migration status shows 002 applied
npx tsx database/migrate.ts status

# API responds without 500 errors
curl "http://localhost:9999/.netlify/functions/comments?proposalId=<uuid>"
# Returns: 200 OK with comments array (or empty array)
```

**Expected behavior after fix:**
- GET /api/comments returns 200 (no longer 500)
- Polling in CommentThread no longer logs "Failed to fetch comments: undefined"
- Existing comments (if any) display correctly with author information
</verification>

<success_criteria>

1. Migration 002 executed successfully without errors
2. `npx tsx database/migrate.ts status` confirms migration 002 applied
3. Comments API GET endpoint returns 200 status code
4. No "column does not exist" errors in API responses
5. Database schema has author_id, author_type columns in proposal_comments table

</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-and-polish/04-02-SUMMARY.md`
</output>
