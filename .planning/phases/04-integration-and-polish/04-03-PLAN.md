---
phase: 04-integration-and-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - components/proposals/CommentInput.tsx
  - landing-page-new/src/components/CommentInput.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Uploaded file appears once (not duplicated) in preview before submit"
  artifacts:
    - path: "components/proposals/CommentInput.tsx"
      provides: "Cleans uploadingFiles after completion"
      exports: ["PendingAttachment"]
    - path: "landing-page-new/src/components/CommentInput.tsx"
      provides: "Client portal attachment cleanup"
      exports: ["PendingAttachment"]
  key_links:
    - from: "CommentInput.uploadFileItem"
      to: "uploadingFiles state"
      via: "filter after adding to pendingAttachments"
      pattern: "setUploadingFiles.*filter"
---

<objective>
Fix duplicate file preview by removing completed uploads from uploadingFiles array after adding to pendingAttachments.

Purpose: Resolve Gap 1 - files currently appear twice (once as "uploading complete" and once as "pending attachment").
Output: Clean attachment preview showing files only once.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-and-polish/04-UAT.md
@.planning/phases/04-integration-and-polish/04-01-SUMMARY.md

## Root Cause (from UAT diagnosis)

**Gap 1: Duplicate file preview (minor)**
- User reported: "I uploaded one file less than 10mb but I'm seeing the file being displayed twice... once with the complete tag and another with file size info"
- Root cause: Completed files remain in uploadingFiles array while also being added to pendingAttachments
- Location: CommentInput.uploadFileItem function (both portals)
- Fix: Remove from uploadingFiles after adding to pendingAttachments

**Note:** Gaps 2 & 3 (attachment submission) are already resolved by user.

## Debug Session

See detailed analysis: `.planning/debug/file-preview-duplicate.md`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix duplicate file preview in CommentInput</name>
  <files>
components/proposals/CommentInput.tsx
landing-page-new/src/components/CommentInput.tsx
  </files>
  <action>
In both CommentInput components (admin and client portals), locate the `uploadFileItem` function.

After successfully adding a completed file to `pendingAttachments`, remove it from `uploadingFiles` to prevent duplicate display.

**Current behavior (both files, ~line 130-140):**
```typescript
// After upload completes
setPendingAttachments(prev => [...prev, { id, name, size, r2Key }]);
// BUG: uploadingFiles still contains this item
```

**Fix (add after setPendingAttachments):**
```typescript
setPendingAttachments(prev => [...prev, { id, name, size, r2Key }]);
// Remove from uploadingFiles to prevent duplicate display
setUploadingFiles(prev => prev.filter(f => f.id !== id));
```

**Why this works:** Completed files should only appear in pendingAttachments (showing "ready to submit"). Leaving them in uploadingFiles causes duplicate rendering - once as "uploading complete" and once as "pending attachment."

Apply this fix to:
1. `components/proposals/CommentInput.tsx` (admin portal)
2. `landing-page-new/src/components/CommentInput.tsx` (client portal)
  </action>
  <verify>
Manual test:
1. Upload a file <10MB
2. Wait for upload to complete
3. Verify file appears ONCE in preview (not twice)
4. Check that only one file preview element is rendered
  </verify>
  <done>
Uploaded files appear once in preview. No duplicate display with "complete" tag and file size info.
  </done>
</task>

</tasks>

<verification>

**Single file preview test:**

1. **Upload single file:**
   - File appears once in preview (not duplicated)
   - No "Complete" tag shown alongside file size
   - Only one preview element visible

**Test in both portals:**
- Admin portal (Vite SPA)
- Client portal (Next.js)
</verification>

<success_criteria>

1. Uploaded files appear once in preview (no duplicate display)
2. File removed from uploadingFiles after adding to pendingAttachments
3. Both admin and client portals handle preview correctly
4. No duplicate rendering in UI

</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-and-polish/04-03-SUMMARY.md`
</output>
