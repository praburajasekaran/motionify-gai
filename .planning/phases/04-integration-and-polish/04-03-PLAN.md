---
phase: 04-integration-and-polish
plan: 03
type: execute
wave: 2
depends_on: [04-02]
files_modified:
  - components/proposals/CommentInput.tsx
  - components/proposals/CommentThread.tsx
  - landing-page-new/src/components/CommentInput.tsx
  - landing-page-new/src/components/CommentThread.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Uploaded file appears once (not duplicated) in preview before submit"
    - "Submit button posts comment with single file attachment to database"
    - "Multiple file attachments can be submitted with a single comment"
    - "comment_attachments table populated with correct comment_id after submit"
  artifacts:
    - path: "components/proposals/CommentInput.tsx"
      provides: "Cleans uploadingFiles after completion, passes attachmentIds to onSubmit"
      exports: ["PendingAttachment"]
    - path: "components/proposals/CommentThread.tsx"
      provides: "Receives and uses attachmentIds parameter in handleSubmit"
      pattern: "handleSubmit.*attachmentIds"
    - path: "landing-page-new/src/components/CommentInput.tsx"
      provides: "Client portal attachment cleanup and submission"
      exports: ["PendingAttachment"]
    - path: "landing-page-new/src/components/CommentThread.tsx"
      provides: "Client portal attachment submission handler"
      pattern: "handleSubmit.*attachmentIds"
  key_links:
    - from: "CommentInput.uploadFileItem"
      to: "pendingAttachments state"
      via: "setPendingAttachments after upload"
      pattern: "setPendingAttachments.*uploadingFiles"
    - from: "CommentInput.handleSubmit"
      to: "onSubmit callback"
      via: "extract r2Keys and pass as second param"
      pattern: "onSubmit.*attachmentIds"
    - from: "CommentThread.handleSubmit"
      to: "createComment API"
      via: "pass attachmentIds parameter"
      pattern: "createComment.*attachmentIds"
---

<objective>
Fix attachment data flow so files appear once in preview, submit correctly with comments, and link to comments in database via comment_attachments table.

Purpose: Resolve three related gaps - duplicate preview display, single attachment not submitting, multiple attachments not submitting.
Output: Clean attachment preview, successful comment submission with files, comment_attachments records created.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-and-polish/04-UAT.md
@.planning/phases/04-integration-and-polish/04-01-SUMMARY.md

## Root Causes (from UAT diagnosis)

**Gap 1: Duplicate file preview (minor)**
- Root cause: Completed files remain in uploadingFiles array while also being added to pendingAttachments
- Location: CommentInput.uploadFileItem function
- Fix: Remove from uploadingFiles after adding to pendingAttachments

**Gap 2 & 3: Comments not submitting with attachments (major)**
- Root cause: CommentInput.handleSubmit only passes content to onSubmit, ignoring pendingAttachments
- Admin portal location: `components/proposals/CommentInput.tsx` line 166
- Client portal location: `landing-page-new/src/components/CommentInput.tsx` line 166
- Fix: Extract r2Keys from pendingAttachments and pass to onSubmit as second parameter
- Secondary fix: Update CommentThread.handleSubmit to accept and use attachmentIds parameter

## Debug Sessions

See detailed analysis:
- `.planning/debug/file-preview-duplicate.md`
- `.planning/debug/comment-submit-with-attachment.md`
- `.planning/debug/multiple-file-upload-not-submitted.md`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix duplicate file preview in CommentInput</name>
  <files>
components/proposals/CommentInput.tsx
landing-page-new/src/components/CommentInput.tsx
  </files>
  <action>
In both CommentInput components (admin and client portals), locate the `uploadFileItem` function.

After successfully adding a completed file to `pendingAttachments`, remove it from `uploadingFiles` to prevent duplicate display.

**Current behavior (both files, ~line 140-160):**
```typescript
// After upload completes
setPendingAttachments(prev => [...prev, { id, name, size, r2Key }]);
// BUG: uploadingFiles still contains this item
```

**Fix (add after setPendingAttachments):**
```typescript
setPendingAttachments(prev => [...prev, { id, name, size, r2Key }]);
// Remove from uploadingFiles to prevent duplicate display
setUploadingFiles(prev => prev.filter(f => f.id !== id));
```

**Why this works:** Completed files should only appear in pendingAttachments (showing "ready to submit"). Leaving them in uploadingFiles causes duplicate rendering - once as "uploading complete" and once as "pending attachment."

Apply this fix to:
1. `components/proposals/CommentInput.tsx` (admin portal)
2. `landing-page-new/src/components/CommentInput.tsx` (client portal)
  </action>
  <verify>
Manual test:
1. Upload a file <10MB
2. Wait for upload to complete
3. Verify file appears ONCE in preview (not twice)
4. Check console for no duplicate rendering logs
  </verify>
  <done>
Uploaded files appear once in preview. No duplicate display with "complete" tag and file size info.
  </done>
</task>

<task type="auto">
  <name>Task 2: Pass attachmentIds from CommentInput to onSubmit callback</name>
  <files>
components/proposals/CommentInput.tsx
landing-page-new/src/components/CommentInput.tsx
  </files>
  <action>
In both CommentInput components, update the `handleSubmit` function to extract r2Keys from pendingAttachments and pass them to the onSubmit callback.

**Current code (~line 166 in both files):**
```typescript
const handleSubmit = async () => {
  if (!content.trim()) return;

  await onSubmit(content.trim());
  // BUG: attachments are never passed to parent

  setContent('');
  setPendingAttachments([]);
};
```

**Updated code:**
```typescript
const handleSubmit = async () => {
  if (!content.trim()) return;

  // Extract r2Keys from pending attachments
  const attachmentIds = pendingAttachments.map(a => a.r2Key);

  // Pass both content and attachmentIds to parent
  await onSubmit(content.trim(), attachmentIds);

  setContent('');
  setPendingAttachments([]);
};
```

**Also update the onSubmit prop interface declaration (~line 20-30):**
```typescript
interface CommentInputProps {
  onSubmit: (content: string, attachmentIds?: string[]) => Promise<void>;
  // ... other props
}
```

Apply to both:
1. `components/proposals/CommentInput.tsx` (admin portal)
2. `landing-page-new/src/components/CommentInput.tsx` (client portal)
  </action>
  <verify>
Code inspection:
1. `grep -n "await onSubmit" components/proposals/CommentInput.tsx` shows attachmentIds parameter
2. `grep -n "await onSubmit" landing-page-new/src/components/CommentInput.tsx` shows attachmentIds parameter
3. Both files show updated interface signature with optional attachmentIds parameter
  </verify>
  <done>
CommentInput.handleSubmit extracts and passes attachmentIds to onSubmit callback in both portals.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update CommentThread.handleSubmit to receive and use attachmentIds</name>
  <files>
components/proposals/CommentThread.tsx
landing-page-new/src/components/CommentThread.tsx
  </files>
  <action>
In both CommentThread components, update the `handleSubmit` function signature to accept attachmentIds parameter and pass it to the createComment API call.

**Current code (both portals):**
```typescript
const handleSubmit = async (content: string) => {
  try {
    await createComment({
      proposalId,
      content,
      userId, // or clientId in client portal
      userName,
      // BUG: attachmentIds never passed to API
    });
    // ...
  }
};
```

**Updated code:**
```typescript
const handleSubmit = async (content: string, attachmentIds?: string[]) => {
  try {
    await createComment({
      proposalId,
      content,
      userId, // or clientId in client portal
      userName,
      attachmentIds, // Now passed to API
    });
    // ...
  }
};
```

**Verify createComment API signature:**
The `createComment` function in `lib/comments.ts` should already accept attachmentIds as part of its payload (added in Phase 03). If not present, add it to the interface.

Apply to both:
1. `components/proposals/CommentThread.tsx` (admin portal)
2. `landing-page-new/src/components/CommentThread.tsx` (client portal)
  </action>
  <verify>
1. Code inspection: Both handleSubmit functions accept attachmentIds parameter
2. Code inspection: Both pass attachmentIds to createComment API call
3. Manual test: Upload file, submit comment, check Network tab - POST /api/comments includes attachmentIds in payload
4. Database check: After submitting comment with attachment, query comment_attachments table - record exists with correct comment_id
  </verify>
  <done>
Comments submit successfully with attachments. comment_attachments table populated with correct comment_id. Multiple attachments work correctly.
  </done>
</task>

</tasks>

<verification>

**End-to-end attachment flow:**

1. **Upload single file:**
   - File appears once in preview (not duplicated)
   - Submit comment
   - Comment appears in thread with attachment visible
   - Download link works
   - Database: comment_attachments has 1 record with correct comment_id

2. **Upload multiple files:**
   - All files appear once in preview
   - Submit comment
   - Comment appears with all attachments
   - All download links work
   - Database: comment_attachments has N records for N files

3. **Remove attachment before submit:**
   - Upload file, see in preview
   - Click remove
   - File disappears
   - Submit comment
   - Comment appears WITHOUT attachment
   - Database: No comment_attachments record for removed file

**Test in both portals:**
- Admin portal (Vite SPA)
- Client portal (Next.js)
</verification>

<success_criteria>

1. Uploaded files appear once in preview (no duplicate display)
2. Comments with single attachment submit successfully
3. Comments with multiple attachments submit successfully
4. comment_attachments table populated correctly after submit
5. Attachment download links work after submit
6. Both admin and client portals handle attachment flow correctly
7. No 500 errors during attachment submission
8. Removed attachments do not appear in submitted comment

</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-and-polish/04-03-SUMMARY.md`
</output>
