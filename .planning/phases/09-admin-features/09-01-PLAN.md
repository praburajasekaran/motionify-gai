---
phase: 09-admin-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/011_create_activities_table.sql
  - netlify/functions/dashboard-metrics.ts
  - netlify/functions/activities.ts
autonomous: true

must_haves:
  truths:
    - "Activities table exists in database with correct schema"
    - "Dashboard metrics endpoint returns aggregated platform statistics"
    - "Activities API supports fetching all activities (not just by context)"
  artifacts:
    - path: "database/migrations/011_create_activities_table.sql"
      provides: "Activities table with indexes"
      contains: "CREATE TABLE activities"
    - path: "netlify/functions/dashboard-metrics.ts"
      provides: "Aggregated metrics from projects, proposals, payments, deliverables"
      exports: ["handler"]
    - path: "netlify/functions/activities.ts"
      provides: "Enhanced GET supporting userId filter and global fetch for admins"
  key_links:
    - from: "netlify/functions/dashboard-metrics.ts"
      to: "database"
      via: "SQL aggregation query"
      pattern: "SELECT.*COUNT.*FROM.*projects"
    - from: "netlify/functions/activities.ts"
      to: "database"
      via: "SQL query with optional userId filter"
      pattern: "FROM activities"
---

<objective>
Create the foundational database table and API endpoints needed for the admin dashboard and activity log features.

Purpose: The activities table is a critical missing piece — the API exists but has no underlying table. The dashboard-metrics endpoint provides efficient aggregated statistics in a single query. The activities API needs enhancement to support admin-level queries (all activities, not just per-context).

Output: Migration file for activities table, new dashboard-metrics Netlify function, enhanced activities.ts with admin query support.
</objective>

<execution_context>
@/Users/praburajasekaran/.claude/get-shit-done/workflows/execute-plan.md
@/Users/praburajasekaran/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@netlify/functions/activities.ts
@netlify/functions/_shared/middleware.ts
@netlify/functions/_shared/schemas.ts
@netlify/functions/_shared/cors.ts
@services/activityApi.ts
@database/schema.sql
@database/migrations/009_payment_webhook_logs.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activities table migration</name>
  <files>database/migrations/011_create_activities_table.sql</files>
  <action>
    Create migration file `database/migrations/011_create_activities_table.sql` with:

    ```sql
    CREATE TABLE IF NOT EXISTS activities (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      type VARCHAR(100) NOT NULL,
      user_id UUID NOT NULL REFERENCES users(id),
      user_name VARCHAR(255) NOT NULL,
      target_user_id UUID REFERENCES users(id),
      target_user_name VARCHAR(255),
      inquiry_id UUID REFERENCES inquiries(id),
      proposal_id UUID REFERENCES proposals(id),
      project_id UUID REFERENCES projects(id),
      details JSONB DEFAULT '{}',
      created_at TIMESTAMPTZ DEFAULT NOW()
    );
    ```

    Add indexes:
    - `idx_activities_user` on `(user_id)`
    - `idx_activities_project` on `(project_id)`
    - `idx_activities_proposal` on `(proposal_id)`
    - `idx_activities_inquiry` on `(inquiry_id)`
    - `idx_activities_type` on `(type)`
    - `idx_activities_created_at` on `(created_at DESC)`

    Do NOT add the CHECK constraint from research — the existing activities API allows context-less activities to be POSTed and the Zod schema in _shared/schemas.ts handles validation via .refine(). Adding a DB constraint would cause runtime failures for edge cases.

    Also update `database/schema.sql` to include the activities table definition for documentation purposes.
  </action>
  <verify>File exists at database/migrations/011_create_activities_table.sql with CREATE TABLE and all 6 indexes.</verify>
  <done>Activities table migration ready to apply. Schema includes all columns matching the existing API contract in activities.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard-metrics endpoint and enhance activities API</name>
  <files>
    netlify/functions/dashboard-metrics.ts
    netlify/functions/activities.ts
  </files>
  <action>
    **Part A: Create `netlify/functions/dashboard-metrics.ts`**

    New Netlify function that returns aggregated platform metrics in a single efficient query. Follow the exact patterns from existing functions (activities.ts, payments.ts):

    - Use compose(withCORS, withAuth, withRateLimit) middleware chain
    - Require super_admin or project_manager role (check auth.user.role)
    - GET only — return 405 for other methods
    - Single SQL query using LEFT JOINs and COUNT/SUM with FILTER:
      - `total_projects` (COUNT of projects)
      - `active_projects` (WHERE status = 'active')
      - `total_proposals` (COUNT of proposals)
      - `pending_proposals` (WHERE status = 'sent')
      - `accepted_proposals` (WHERE status = 'accepted')
      - `total_payments` (COUNT of payments)
      - `completed_payments` (WHERE status = 'completed')
      - `total_revenue` (SUM amount WHERE status = 'completed')
      - `pending_revenue` (SUM amount WHERE status = 'pending')
      - `total_inquiries` (COUNT of inquiries)
      - `new_inquiries` (WHERE status = 'new')
      - `pending_deliverables` (COUNT WHERE status = 'awaiting_approval')
    - Use separate COUNT queries per table (not a massive JOIN which would cause cartesian product issues):
      ```sql
      SELECT
        (SELECT COUNT(*) FROM projects) as total_projects,
        (SELECT COUNT(*) FROM projects WHERE status = 'active') as active_projects,
        (SELECT COUNT(*) FROM proposals) as total_proposals,
        ...
      ```
    - Transform snake_case to camelCase in response
    - Return JSON: `{ totalProjects, activeProjects, totalProposals, pendingProposals, acceptedProposals, totalPayments, completedPayments, totalRevenue, pendingRevenue, totalInquiries, newInquiries, pendingDeliverables }`

    **Part B: Enhance `netlify/functions/activities.ts` GET handler**

    Add support for admin-level activity queries needed by the activity log page:

    1. Add optional `userId` query parameter — when provided, filter `WHERE a.user_id = $N`
    2. Add optional `offset` query parameter for pagination (Load More)
    3. When NO context params (inquiryId/proposalId/projectId) provided AND user is super_admin or project_manager, return ALL activities (remove the 400 error for admins)
    4. Keep the 400 error for non-admin users who don't provide context
    5. Add JOINs to include context names in the response:
       ```sql
       LEFT JOIN projects p ON a.project_id = p.id
       LEFT JOIN proposals pr ON a.proposal_id = pr.id
       LEFT JOIN inquiries i ON a.inquiry_id = i.id
       ```
    6. Add `projectName` (from p.project_number or p.name), `proposalId`, and `inquiryNumber` (from i.inquiry_number) to the response object

    **Important:** The auth parameter is already available as the second argument from withAuth middleware. Check `auth?.user?.role` for admin detection.
  </action>
  <verify>
    1. `netlify/functions/dashboard-metrics.ts` exists and exports a handler
    2. `npm run build` passes (or `npx tsc --noEmit` on the functions)
    3. activities.ts GET handler supports userId and offset parameters
    4. activities.ts returns context names (projectName, inquiryNumber) via JOINs
  </verify>
  <done>
    Dashboard metrics endpoint returns 12 aggregated platform statistics.
    Activities API supports admin-level global queries with userId filter, offset pagination, and context name JOINs.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists with correct schema matching activities.ts contract
2. dashboard-metrics.ts compiles and follows middleware pattern
3. activities.ts enhanced GET supports: no-context admin queries, userId filter, offset, context JOINs
4. Build passes (npm run build)
</verification>

<success_criteria>
- Activities table migration ready at database/migrations/011_create_activities_table.sql
- Dashboard metrics endpoint returns aggregated stats from projects/proposals/payments/inquiries/deliverables
- Activities API allows admins to fetch all activities with pagination and context names
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-features/09-01-SUMMARY.md`
</output>
